openapi: 3.0.3
info:
  title: Example Receiver Service API
  description: |
    REST API for the Example Receiver Service, a reference implementation demonstrating 
    HomeHelper's message consumer pattern. This service subscribes to Redis events and 
    persists messages to rotating files.
    
    ## Features
    - Health monitoring with detailed metrics
    - File browsing and retrieval
    - Message batch management
    - HomeHelper-compliant API structure
    
  version: 1.0.0
  contact:
    name: HomeHelper Team
  license:
    name: MIT

servers:
  - url: http://localhost:8200
    description: Local development server
  - url: http://localhost:{port}
    description: Dynamic port assigned by HomeHelper
    variables:
      port:
        default: '8200'
        description: Port assigned by HomeHelper main application

tags:
  - name: Health
    description: Service health and status monitoring
  - name: UI
    description: UI resource discovery
  - name: Files
    description: Message file management and retrieval

paths:
  /health:
    get:
      tags:
        - Health
      summary: Get service health status
      description: |
        Returns the current health status of the service including metrics about 
        message processing, file counts, and Redis connectivity.
        
        Health status values:
        - `good`: Service operating normally
        - `warning`: Redis connection issues or no recent messages (5+ minutes)
        - `error`: Critical failure
        
      operationId: getHealth
      responses:
        '200':
          description: Health status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Service running normally
                  value:
                    health: good
                    message: Receiver service running normally
                    extra_info:
                      total_messages_received: 456
                      current_batch_number: 46
                      messages_in_current_batch: 6
                      total_files: 45
                      last_message_received: "2025-10-16 14:30:00"
                      redis_connected: true
                warning:
                  summary: Redis connection issue
                  value:
                    health: warning
                    message: Redis connection issue
                    extra_info:
                      total_messages_received: 456
                      current_batch_number: 46
                      messages_in_current_batch: 6
                      total_files: 45
                      redis_connected: false

  /ui:
    get:
      tags:
        - UI
      summary: Get available UI resources
      description: |
        Returns a list of available resource types that can be accessed via the API.
        This endpoint is used by the HomeHelper dashboard to discover available data.
        
      operationId: getUIResources
      responses:
        '200':
          description: List of available resources
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                example: ["files"]

  /api/files:
    get:
      tags:
        - Files
      summary: List all message batch files
      description: |
        Returns metadata for all message batch files in chronological order.
        Each file contains up to 10 messages. The last file may contain fewer 
        messages if it's the current active batch.
        
      operationId: listFiles
      responses:
        '200':
          description: List of file metadata
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FileMetadata'
              examples:
                multipleFiles:
                  summary: Multiple batch files
                  value:
                    - id: 1
                      filename: messages_batch_0001.txt
                      message_count: 10
                      file_size_bytes: 732
                      date_created: 1704067200
                      date_modified: 1704067500
                    - id: 2
                      filename: messages_batch_0002.txt
                      message_count: 10
                      file_size_bytes: 750
                      date_created: 1704067800
                      date_modified: 1704068100
                    - id: 3
                      filename: messages_batch_0003.txt
                      message_count: 7
                      file_size_bytes: 520
                      date_created: 1704068400
                      date_modified: 1704068610
                emptyList:
                  summary: No files yet
                  value: []

  /api/files/{id}:
    get:
      tags:
        - Files
      summary: Get specific message batch file
      description: |
        Returns detailed information about a specific batch file including 
        full content, message count, and parsed message numbers.
        
      operationId: getFile
      parameters:
        - name: id
          in: path
          required: true
          description: Batch number (ID) of the file to retrieve
          schema:
            type: integer
            minimum: 1
          example: 1
      responses:
        '200':
          description: File details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileDetails'
              examples:
                completeFile:
                  summary: Complete batch file (10 messages)
                  value:
                    id: 1
                    filename: messages_batch_0001.txt
                    message_count: 10
                    file_size_bytes: 732
                    date_created: 1704067200
                    date_modified: 1704067500
                    content: |
                      [2025-10-16 14:56:05] Message #1: Test message 1
                      [2025-10-16 14:56:06] Message #2: Test message 2
                      [2025-10-16 14:56:07] Message #3: Test message 3
                      [2025-10-16 14:56:08] Message #4: Test message 4
                      [2025-10-16 14:56:09] Message #5: Test message 5
                      [2025-10-16 14:56:10] Message #6: Test message 6
                      [2025-10-16 14:56:11] Message #7: Test message 7
                      [2025-10-16 14:56:12] Message #8: Test message 8
                      [2025-10-16 14:56:13] Message #9: Test message 9
                      [2025-10-16 14:56:14] Message #10: Test message 10
                    first_message_number: 1
                    last_message_number: 10
                partialFile:
                  summary: Partial batch file (current batch)
                  value:
                    id: 3
                    filename: messages_batch_0003.txt
                    message_count: 5
                    file_size_bytes: 375
                    date_created: 1704068400
                    date_modified: 1704068610
                    content: |
                      [2025-10-16 15:00:00] Message #21: Test message 21
                      [2025-10-16 15:00:30] Message #22: Test message 22
                      [2025-10-16 15:01:00] Message #23: Test message 23
                      [2025-10-16 15:01:30] Message #24: Test message 24
                      [2025-10-16 15:02:00] Message #25: Test message 25
                    first_message_number: 21
                    last_message_number: 25
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "File with id 999 not found. It may not exist yet."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Error reading file: Permission denied"

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - health
        - message
      properties:
        health:
          type: string
          enum: [good, warning, error]
          description: Overall health status of the service
          example: good
        message:
          type: string
          maxLength: 100
          description: Human-readable status description
          example: Receiver service running normally
        extra_info:
          type: object
          description: Additional metrics and status information
          properties:
            total_messages_received:
              type: integer
              description: Total number of messages processed since startup
              example: 456
            current_batch_number:
              type: integer
              description: Current batch file number
              example: 46
            messages_in_current_batch:
              type: integer
              minimum: 0
              maximum: 10
              description: Number of messages in the current batch (0-10)
              example: 6
            total_files:
              type: integer
              description: Total number of batch files created
              example: 45
            last_message_received:
              type: string
              format: date-time
              description: Timestamp of the last message received (YYYY-MM-DD HH:MM:SS)
              example: "2025-10-16 14:30:00"
            redis_connected:
              type: boolean
              description: Whether Redis connection is active
              example: true

    FileMetadata:
      type: object
      required:
        - id
        - filename
        - message_count
        - file_size_bytes
        - date_created
        - date_modified
      properties:
        id:
          type: integer
          description: Batch number (unique identifier)
          example: 1
        filename:
          type: string
          pattern: '^messages_batch_\d{4,}\.txt$'
          description: Name of the batch file
          example: messages_batch_0001.txt
        message_count:
          type: integer
          minimum: 0
          maximum: 10
          description: Number of messages in the file
          example: 10
        file_size_bytes:
          type: integer
          description: File size in bytes
          example: 732
        date_created:
          type: integer
          format: int64
          description: Unix timestamp of file creation
          example: 1704067200
        date_modified:
          type: integer
          format: int64
          description: Unix timestamp of last modification
          example: 1704067500

    FileDetails:
      allOf:
        - $ref: '#/components/schemas/FileMetadata'
        - type: object
          required:
            - content
          properties:
            content:
              type: string
              description: Full file content with all messages
              example: |
                [2025-10-16 14:56:05] Message #1: Test message 1
                [2025-10-16 14:56:06] Message #2: Test message 2
            first_message_number:
              type: integer
              nullable: true
              description: Message number of the first message in the file
              example: 1
            last_message_number:
              type: integer
              nullable: true
              description: Message number of the last message in the file
              example: 10

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message describing what went wrong
          example: "File with id 999 not found. It may not exist yet."

  examples:
    HealthyService:
      summary: Service operating normally
      value:
        health: good
        message: Receiver service running normally
        extra_info:
          total_messages_received: 456
          current_batch_number: 46
          messages_in_current_batch: 6
          total_files: 45
          last_message_received: "2025-10-16 14:30:00"
          redis_connected: true

    WarningService:
      summary: Service with warnings
      value:
        health: warning
        message: No messages received in 300 seconds
        extra_info:
          total_messages_received: 456
          current_batch_number: 46
          messages_in_current_batch: 6
          total_files: 45
          last_message_received: "2025-10-16 14:25:00"
          redis_connected: true

    ErrorService:
      summary: Service with errors
      value:
        health: error
        message: Redis connection issue
        extra_info:
          total_messages_received: 456
          current_batch_number: 46
          messages_in_current_batch: 6
          total_files: 45
          redis_connected: false
